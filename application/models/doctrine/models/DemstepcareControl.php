<?php

/**
 * DemstepcareControl
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ISPC
 * @subpackage Application (2019-10-02)
 * @author     Ancuta <office@originalware.com>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class DemstepcareControl extends BaseDemstepcareControl
{

    /**
     * translations are grouped into an array
     *
     * @var unknown
     */
    const LANGUAGE_ARRAY = 'demstepcarecontrol_lang';

    /**
     * define the FORMID and FORMNAME, if you want to piggyback some triggers
     *
     * @var unknown
     */
    const TRIGGER_FORMID = null;

    const TRIGGER_FORMNAME = 'frm_demstepcarecontrol';

    /**
     * insert into patient_files will use this
     */
    const PATIENT_FILE_TABNAME = 'DemstepcareControl';

    const PATIENT_FILE_TITLE = 'DemstepcareControl PDF'; // this will be translated

    /**
     * insert into patient_course will use this
     */
    const PATIENT_COURSE_TITLE = 'DemstepcareControl PDF was created';

    const PATIENT_COURSE_TABNAME = 'demstepcarecontrol';

    const PATIENT_COURSE_TYPE = ''; // add letter

    public function get_rp_controlsheet($ipid, $date_start = false, $date_end = false)
    {
        $query = Doctrine_Query::create()->select('*')
            ->from('RlpControl')
            ->where('ipid = ?', $ipid)
            ->andWhere('isdelete="0"');
        
        if ($date_start && ! $date_end) {
            $query->andWhere('MONTH(date) = MONTH("' . $date_start . '")');
            $query->andWhere('YEAR(date) = YEAR("' . $date_start . '")');
        } else 
            if ($date_start && $date_end) {
                $query->andWhere('DATE(date) BETWEEN DATE("' . $date_start . '") AND DATE("' . $date_end . '")');
            }
        
        $q_res = $query->fetchArray();
        
        if ($q_res) {
            foreach ($q_res as $k_res => $v_res) {
                $formated_date = date('Y-m-d', strtotime($v_res['date']));
                $master_data[$v_res['shortcut']][$formated_date]['p_home'] = $v_res['qty_home'];
                $master_data[$v_res['shortcut']][$formated_date]['p_nurse'] = $v_res['qty_nurse'];
                $master_data[$v_res['shortcut']][$formated_date]['p_hospiz'] = $v_res['qty_hospiz'];
            }
            
            return $master_data;
        } else {
            return false;
        }
    }

    public function saved_dsc_controlsheets($ipids, $specific_period_days = false)
    {
        if (empty($ipids)) {
            return false;
        }
        
        if (! is_array($ipids)) {
            $ipids = array(
                $ipids
            );
        }
        
        $sql_str = "";
        if ($specific_period_days) {
            foreach ($specific_period_days as $sp_ipid => $sp_days) {
                
                if(isset($sp_days['start'])){
                    $period[$sp_ipid]['start'] = $sp_days['start'];
                }
                else
                {
                    $period[$sp_ipid]['start'] = $sp_days[0];
                }
                
                
                if(isset($sp_days['end'])){
                    $period[$sp_ipid]['end'] = $sp_days['end'];
                }
                else
                {
                    $period[$sp_ipid]['end'] = end($sp_days);
                }
                
//                 $period[$sp_ipid]['start'] = $sp_days[0];
//                 $period[$sp_ipid]['end'] = end($sp_days);
            }
         
            foreach ($period as $ipid => $v_data) {
                $sql_data[] = "(`ipid` LIKE '" . $ipid . "' AND (`quarterly_date` BETWEEN '" . date('Y-m-d', strtotime($v_data['start'])) . "' AND '" . date('Y-m-d', strtotime($v_data['end'])) . "') )";
            }
            
            $sql_str = implode(' OR ', $sql_data);
        } else {
            $period = false;
        }
      
        $query = Doctrine_Query::create()->select('*')
            ->from('DemstepcareControl')
            ->whereIn('ipid', $ipids)
            ->andWhere('isdelete="0"');
        if (strlen($sql_str) > 0) {
            $query->andWhere($sql_str);
        }
        
        $q_res = $query->fetchArray();
     
        if ($q_res) {
            foreach ($q_res as $k_res => $v_res) {
                $formated_date = date("d.m.Y", strtotime($v_res['quarterly_date']));
                
                if ($specific_period_days) {
                    if(isset($specific_period_days[$v_res['ipid']]['days'])){
                        
                        if (in_array($formated_date, $specific_period_days[$v_res['ipid']]['days'])) {
                            $master_data[$v_res['ipid']][$v_res['shortcut']][$v_res['quarter']] = $v_res;
                        }
                        
                    }else{
                        if (in_array($formated_date, $specific_period_days[$v_res['ipid']])) {
                            $master_data[$v_res['ipid']][$v_res['shortcut']][$v_res['quarter']] = $v_res;
                        }
                    }
                } else {
                    $master_data[$v_res['ipid']][$v_res['quarter']][$v_res['shortcut']] = $v_res;
                }
            }
        } else {
            $master_data = false;
        }
        
        return $master_data;
    }

    public function get_dsc_controlsheets($ipids, $specific_period_days = false, $target = "form")
    {
        if (empty($ipids)) {
            return false;
        }
        
        if (! is_array($ipids)) {
            $ipids = array(
                $ipids
            );
        }
        
        $master_data = $this->dsc_actions($ipids, $specific_period_days, $target);
        
        return $master_data;
    }

    public function dsc_actions($ipids, $specific_period_days = false, $target = "form")
    {
        if (empty($ipids)) {
            return false;
        }
        
        if (! is_array($ipids)) {
            $ipids = array(
                $ipids
            );
        }
        
        if ($specific_period_days) {
            foreach ($specific_period_days as $sp_ipid => $sp_days) {
                
                if(isset($sp_days['start'])){
                    $period[$sp_ipid]['start'] = $sp_days['start'];
                }
                else
                {
                    $period[$sp_ipid]['start'] = $sp_days[0];
                }
                
                
                if(isset($sp_days['end'])){
                    $period[$sp_ipid]['end'] = $sp_days['end'];
                }
                else
                {
                    $period[$sp_ipid]['end'] = end($sp_days);
                }
            }
        } else {
            $period = false;
        }
        
        $logininfo = new Zend_Session_Namespace('Login_Info');
        $clientid = $logininfo->clientid;
        $userid = $logininfo->userid;
        
        // Models
        $patientmaster_obj = new PatientMaster();
        $client_obj = new Client();
        $sapv_obj = new SapvVerordnung();
        $conatct_form_obj = new ContactForms();
        $price_list_obj = new PriceList();
        $InvoiceSystem_obj = new InvoiceSystem();
        $PatientCourse_obj = new PatientCourse();
        
        // OVERALL
        $conditions_overall['periods'][0]['start'] = '2009-01-01';
        $conditions_overall['periods'][0]['end'] = date('Y-m-d');
        $conditions_overall['client'] = $clientid;
        $conditions_overall['ipids'] = $ipids;
        
        // beware of date d.m.Y format here
        $patient_overall_days = Pms_CommonData::patients_days($conditions_overall);
        
        if (! isset($patient_overall_days)) {
            $patient_overall_days = array();
        }
        $patient_days2locationtypes = array();
        $hospital_days_cs_dmY = array();
        $hospiz_days_cs_dmY = array();
        $patient_active_days = array();
        $patient_treatment_days = array();
        $first_admission_day = array();
        $first_admission_Quarter= array();
        
        $admission_periods = array();
        
        foreach ($patient_overall_days as $k_patient => $patient_data) {
            
            $patient_active_days[$k_patient] = $patient_data['real_active_days'];
            $patient_treatment_days[$k_patient] = $patient_data['treatment_days'];
            
            // hospital days cs
            if (! empty($patient_data['hospital']['real_days_cs'])) {
                $hospital_days_cs_dmY[$k_patient] = $patient_data['hospital']['real_days_cs'];
                $patient_active_days[$k_patient] = array_diff($patient_data['real_active_days'], $patient_data['hospital']['real_days_cs']);
            }
            
            // hospiz days cs
            if (! empty($patient_data['hospiz']['real_days_cs'])) {
                $hospiz_days_cs_dmY[$k_patient] = $patient_data['hospiz']['real_days_cs'];
            }
            
            // first_admission_day
            if (! empty($patient_data['admission_days'])) {
                $first_admission_day[$k_patient] = $patient_data['admission_days'][0];
                

                $adm_month = date("n", strtotime($patient_data['admission_days'][0]));
                $adm_yearQuarter = ceil($adm_month / 3);
                $first_admission_Quarter[$k_patient] = '0' . $adm_yearQuarter . '/' . date("Y", strtotime($patient_data['admission_days'][0])) ;
            }
            
            // get admsission periods days. // ISPC-2143 comment 06.06.2018 pct:2) @ancuta
            foreach ($patient_data['active_periods'] as $pk => $v_period) {
                $admission_periods[$k_patient][] = $patientmaster_obj->getDaysInBetween($v_period['start'], $v_period['end'], false, "d.m.Y");
            }
            
            foreach ($patient_data['locations'] as $pat_location_row_id => $pat_location_data) {
                foreach ($pat_location_data['days'] as $kl => $lday) {
                    if (in_array($lday, $patient_data['real_active_days'])) {
                        
                        if (empty($pat_location_data['type'])) {
                            $pat_location_data['type'] = 0;
                        }
                        
                        if ($pat_location_data['discharge_location'] != 1) {
                            $patient_days2locationtypes[$k_patient][$lday][] = $pat_location_data['type'];
                        }
                    }
                }
            }
        }

        
        // form $quarters - ONLY in Requested period
        $quarters = array();
        foreach($ipids as $ipid)
        {
            foreach($patient_active_days[$ipid] as $k=>$act_Day)
            {
                $r1start = strtotime($act_Day);
                $r1end = strtotime($act_Day);
                
                $r2start = strtotime($period[$ipid]['start']);// - taken from $specific_period_days
                $r2end = strtotime($period[$ipid]['end']);// - taken from $specific_period_days
                
                if(Pms_CommonData::isintersected($r1start, $r1end, $r2start, $r2end))
                {
                    $month = date("n", strtotime($act_Day));
                    $yearQuarter = ceil($month / 3);
                    $quarters[$ipid]['0'.$yearQuarter.'/'.date("Y", strtotime($act_Day))][] = date("d.m.Y", strtotime($act_Day));
                }
            }
        }
        
        
        // statuses ( green, yellow, red)
        $status_history_arr = Doctrine_Query::create()->select("*")
            ->from('PatientCrisisHistory')
            ->whereIn("ipid", $ipids)
            ->fetchArray();
        
        foreach ($status_history_arr as $k => $status_rr) {
            $status2patient[$status_rr['ipid']][] = $status_rr;
        }
        
        // get highest status 2 quarter
        foreach ($ipids as $k => $ipid) {
            // sort statuses
            usort($status2patient[$ipid], array("_date_compare"));
                        
            $sident = 0;
            foreach ($status2patient[$ipid] as $sk => $sdata) {
                
                $gap = 0;
                if ($status2patient[$ipid][$sk + 1]['status_date']) {
                    
                    $date1 = new DateTime($sdata['status_date']);
                    $date2 = new DateTime($status2patient[$ipid][$sk + 1]['status_date']);
                    $gap = date_diff($date1, $date2)->days;
                } else {
                    if ($sdata['status_date'] < date("Y-m-d H:i:s")) {
                        $date1 = new DateTime($sdata['status_date']);
                        $date2 = new DateTime(date("Y-m-d H:i:s"));
                        $gap = date_diff($date1, $date2)->days;
                    }
                }
                $add_date = '+' . $gap . 'days';
                $prs[$ipid][$sident]['start'] = $sdata['status_date'];
                $prs[$ipid][$sident]['end'] = date("Y-m-d H:i:s", strtotime($add_date, strtotime($sdata['status_date'])));
                $prs[$ipid][$sident]['days'] = PatientMaster::getDaysInBetween(date("Y-m-d", strtotime($prs[$ipid][$sident]['start'])), date("Y-m-d", strtotime($prs[$ipid][$sident]['end'])), false);
                $prs[$ipid][$sident]['status'] = $sdata['crisis_status'];
                
                if ($sdata['crisis_status'] != $status2patient[$ipid][$sk + 1]['crisis_status'] || $gap > 1) {
                    $sident ++;
                }
            }
            foreach ($prs[$ipid] as $int => $intvalues) {
                foreach ($intvalues['days'] as $ik => $status_day) {
                    $patient_day2status[$ipid][$status_day] = $intvalues['status'];
                    
                    $month = date("n", strtotime($status_day));
                    $yearQuarter = ceil($month / 3);
                    $patient_day2status_q[$ipid]['0' . $yearQuarter . '/' . date("Y", strtotime($status_day))][] = $intvalues['status'];
                }
            }
            
            foreach ($patient_day2status_q[$ipid] as $quart => $q_statuses) {
                $patient_day2status_per_q[$ipid][$quart] = max($q_statuses);
            }
        }
        
        
        // contact forms
        $conatct_form_arr = array();
        $conatct_form_arr = $conatct_form_obj->get_contactforms_multiple($ipids);
        
        $pateint_cf_days = array();
        if (! empty($conatct_form_arr)) {
            foreach ($conatct_form_arr as $cfid => $cfdata) {
                if(in_array(date('d.m.Y', strtotime($cfdata['billable_date'])),$patient_active_days[$cfdata['ipid']])){
                    $pateint_cf_days[$cfdata['ipid']][] = date('d.m.Y', strtotime($cfdata['billable_date']));
                }
            }
        }
        

        
        $invoice_products = $InvoiceSystem_obj->invoice_products('demstepcare_invoice');
        $sp_products = DemstepcareProductsTable::findPruductsByClient($clientid);
        $client_products_arr = array();
        foreach($sp_products as $k=>$product_details){
            if(in_array($product_details['shortcut'],$invoice_products)){
                $client_products_arr[$product_details['shortcut']] = $product_details['product_name'];
            }
        }
        
        
        
//         dd($pateint_cf_days);
        // price list
        $master_price_list = array();
        foreach ($ipids as $kmp_ipid => $vmp_ipid) {
            $master_price_list[$vmp_ipid] = $price_list_obj->period_price_list_specific_demstepcare($period[$vmp_ipid]['start'], $period[$vmp_ipid]['end']);
        }
//         dd($specific_period_days);
        // ###############
        // get saved data
        // ###############
        $saved_data = array();
        $saved_data = self::saved_dsc_controlsheets($ipids, $specific_period_days);

        $saved_data_overall = array();
        $saved_data_overall = self::saved_dsc_controlsheets($ipids);
        
        
        $day_location_type = "";
        $day_location_dts_digits_1_2 = "";
        $be_aasse_days = array();
        $first_dot_days = array();
        $second_dot_days = array();
        $overall_first_dot_days = array();
        $overall_shortcut_details = array();
        $billable_regional_flatrate = array();
        
        $billable_items  = array();
        foreach ($ipids as $k => $ipid) {
            
            if (! isset($billable_items[$ipid])) {
                $billable_items[$ipid] = array();
            }
            
            
            
            if (! isset($billable_first_dot_days[$ipid])) {
                $billable_first_dot_days[$ipid] = array();
            }
            
            if (! isset($billable_q_adm_days[$ipid])) {
                $billable_q_adm_days[$ipid] = array();
            }
            
            if (! isset($pateint_cf_days[$ipid])) {
                $pateint_cf_days[$ipid] = array();
            }
            

            if (! empty($saved_data_overall[$ipid])) {
                
                foreach ($saved_data_overall[$ipid] as $sh_key => $sh_dates) {
                    foreach ($sh_dates as $quart => $q_values) {
                        if ($q_values['value'] == "1") {
                            $overall_shortcut_details[$ipid][$sh_key][] = date("d.m.Y", strtotime($q_values['quarterly_date']));
                            if ($sh_key == "first_dot") {
                                // $billable_first_dot_days[$ipid][] = date("d.m.Y",strtotime($fvalues['form_date']));
                            }
                        }
                    }
                }
            }
            
            if (! empty($overall_shortcut_details[$ipid]["q_adm"])) {
                $first_dot_ever = $overall_shortcut_details[$ipid]["q_adm"][0];
            }
            // foreach active days if, GREEN and active and visits - trigger
            
            foreach($quarters[$ipid] as $quart_id => $quarter_dates){
                // check if patient has contact forms in current quarted
                $patient_cfs[$quart_id] = array();
                if(!empty($pateint_cf_days[$ipid])){
                    $patient_cfs[$quart_id] = array_intersect($quarter_dates, $pateint_cf_days[$ipid]); 
                }
                
                //1 triggered by admission , can be billed once per patient life 
                $shortcut = "q_adm";
                if (isset($saved_data[$ipid][$shortcut][$quart_id])) {
                    if($saved_data[$ipid][$shortcut][$quart_id]['value'] =='1'){
                        
                        if(!empty($saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'])){
                            $price_date = $saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'];
                        } else{
                            $price_date = $quarter_dates[0];
                        }
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "0";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                    } else {
                        $items[$ipid][$quart_id][$shortcut]['qty'] = 0;
                    }
                    
                } else { 
                    if(empty($billable_items[$ipid][$shortcut])){
                        // if admission date in curent quarted -> then biil q_adm
                        if($first_admission_Quarter[$ipid] == $quart_id){

                            $price_date =   $first_admission_day[$ipid];
                            $day_location_type = "all";
                            $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;
                            $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];                            
                            $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                            $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                            $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                            $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                            $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                            $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                            $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                            $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;    
                            $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                            $items[$ipid][$quart_id][$shortcut]['system']           = "1";
                            $billable_items[$ipid][$shortcut][] = $quart_id;
                            
                        }
                    }
                }
                
                //2 triggered for a quartal in which the STATUS of the patient was GREEN, patient was active and had one visit (on an active day) 
                $shortcut = "q_gav";
                if (isset($saved_data[$ipid][$shortcut][$quart_id])) {
                    if($saved_data[$ipid][$shortcut][$quart_id]['value'] =='1'){
                
                        if(!empty($saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'])){
                            $price_date = $saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'];
                        } else{
                            $price_date = $quarter_dates[0];
                        }
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;           
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];                                     
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;  
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "0";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                    } else {
                        $items[$ipid][$quart_id][$shortcut]['qty'] = 0;
                    }
                
                } else {
                    
                     
                    // if status is GREEN
                    // If patietn has a visit in current quarter
                    // if is active in currect quarted 
                    if( $patient_day2status_per_q[$ipid][$quart_id] == "1" && !empty($patient_cfs[$quart_id])){
            
                        $price_date = $quarter_dates[0];
                        
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;             
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;   
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "1";
                        $billable_q_adm_days[$ipid][] = $quart_id;
                    }
                }
                
                
                
                
                
                
                //3 triggered for a quartal in which the STATUS of the patient was YELLOW, patient was active and had one visit (on an active day) 
                $shortcut = "q_yav";
                if (isset($saved_data[$ipid][$shortcut][$quart_id])) {
                    if($saved_data[$ipid][$shortcut][$quart_id]['value'] =='1'){
                
                        if(!empty($saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'])){
                            $price_date = $saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'];
                        } else{
                            $price_date = $quarter_dates[0];
                        }
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;  
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;   
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "0";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                    } else {
                        $items[$ipid][$quart_id][$shortcut]['qty'] = 0;
                    }
                
                } else {
                
                     
                    // if status is YELLOW
                    // If patietn has a visit in current quarter
                    // if is active in currect quarted
                    if( $patient_day2status_per_q[$ipid][$quart_id] == "2" && !empty($patient_cfs[$quart_id])){
                
                        $price_date = $quarter_dates[0];
                
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;      
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;      
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "1";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                        $billable_q_adm_days[$ipid][] = $quart_id;
                    }
                }
                
                //4   triggered for a quartal in which the STATUS of the patient was RED, patient was active and had one visit (on an active day) 
                $shortcut = "q_rav";
                if (isset($saved_data[$ipid][$shortcut][$quart_id])) {
                    if($saved_data[$ipid][$shortcut][$quart_id]['value'] =='1'){
                
                        if(!empty($saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'])){
                            $price_date = $saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'];
                        } else{
                            $price_date = $quarter_dates[0];
                        }
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;         
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;     
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "0";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                    } else {
                        $items[$ipid][$quart_id][$shortcut]['qty'] = 0;
                    }
                
                } else {
                
                     
                    // if status is RED
                    // If patietn has a visit in current quarter
                    // if is active in currect quarted
                    if( $patient_day2status_per_q[$ipid][$quart_id] == "3" && !empty($patient_cfs[$quart_id])){
                
                        $price_date = $quarter_dates[0];
                
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;      
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;  
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "1";
                        $billable_q_adm_days[$ipid][] = $quart_id;
                    }
                }                
                
                
                
                
                //5 triggered for a quartal in which "case management" is triggered MANUALLY
                $shortcut = "q_case";
                if (isset($saved_data[$ipid][$shortcut][$quart_id])) {
                    if($saved_data[$ipid][$shortcut][$quart_id]['value'] =='1'){
                
                        if(!empty($saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'])){
                            $price_date = $saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'];
                        } else{
                            $price_date = $quarter_dates[0];
                        }
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;  
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "0";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                    } else {
                        $items[$ipid][$quart_id][$shortcut]['qty'] = 0;
                    }
                
                }
                
                //6 triggered for a quartal in which "Krisenmanagement" is triggered MANUALLY
                $shortcut = "q_crisis";
                if (isset($saved_data[$ipid][$shortcut][$quart_id])) {
                    if($saved_data[$ipid][$shortcut][$quart_id]['value'] =='1'){
                
                        if(!empty($saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'])){
                            $price_date = $saved_data[$ipid][$shortcut][$quart_id]['quarterly_date'];
                        } else{
                            $price_date = $quarter_dates[0];
                        }
                        $day_location_type = "all";
                        $items[$ipid][$quart_id][$shortcut]['shortcut']         = $shortcut;        
                        $items[$ipid][$quart_id][$shortcut]['description']      = $client_products_arr[$shortcut];
                        $items[$ipid][$quart_id][$shortcut]['qty']              = 1;
                        $items[$ipid][$quart_id][$shortcut]['value']            = 1;
                        $items[$ipid][$quart_id][$shortcut]['price']            = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_price']        = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price'];
                        $items[$ipid][$quart_id][$shortcut]['dta_id']           = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['dta_id'];
                        $items[$ipid][$quart_id][$shortcut]['price_list']       = $master_price_list[$ipid][date("Y-m-d", strtotime($price_date))][$shortcut][$day_location_type]['price_list'];
                        $items[$ipid][$quart_id][$shortcut]['quarterly_date']   = $price_date;
                        $items[$ipid][$quart_id][$shortcut]['quarter']          = $quart_id;
                        $items[$ipid][$quart_id][$shortcut]['location_type']    = "all";
                        $items[$ipid][$quart_id][$shortcut]['system']           = "0";
                        $billable_items[$ipid][$shortcut][] = $quart_id;
                    } else {
                        $items[$ipid][$quart_id][$shortcut]['qty'] = 0;
                    }
                }
            }
        }
        
//         chack if quarter in specific
        
        if (! empty($specific_period_days)) {
            
            if ($target == "form") {
                
                
                foreach ($items as $patient => $data_arr) {
                    foreach ($data_arr as $qu_id => $shortcut_arr) {
                        if (array_key_exists($qu_id, $quarters[$patient])) { //$quarters array is created from $specific_period_days
                            
                            foreach ($shortcut_arr as $shortcut => $sh_data) {
                                if ($sh_data['qty'] == "1") {
                                    $master_data[$patient][$qu_id][$shortcut] = $sh_data;
                                }
                            }
                        }
                    }
                }
/*                 
                foreach ($items as $patient => $data_arr) {
                    foreach ($data_arr as $day => $shortcut_arr) {
                        if (in_array($day, $specific_period_days[$patient])) {
                            
                            foreach ($shortcut_arr as $shortcut => $sh_data) {
                                if ($sh_data['qty'] == "1") {
                                    $master_data[$patient][$shortcut][date('Y-m-d', strtotime($day))] = $sh_data;
                                }
                            }
                        }
                    }
                } */
                
                
            } elseif ($target == "invoice") {
                
                foreach ($items as $patient => $data_arr) {
                    foreach ($data_arr as $qu_id => $shortcut_arr) {
                        if (array_key_exists($qu_id, $quarters[$patient])) { //$quarters array is created from $specific_period_days
                
                            foreach ($shortcut_arr as $shortcut => $sh_data) {
                                if ($sh_data['qty'] == "1") {
                                    $master_data[$patient][$qu_id][$shortcut] = $sh_data;
                                }
                            }
                        }
                    }
                }
                
       /*          
                foreach ($items as $patient => $data_arr) {
                    foreach ($data_arr as $day => $shortcut_arr) {
                        if (in_array($day, $specific_period_days[$patient])) {
                            foreach ($shortcut_arr as $shortcut => $sh_data) {
                                $master_data[$patient][$shortcut][date('Y-m-d', strtotime($day))] = $sh_data;
                            }
                        }
                    }
                } */
            }
        }
        
//         dd($master_data,$items);
        
        return $master_data;
    }
}