<?php

/**
 * DocxTemplates
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class DocxTemplates extends BaseDocxTemplates
{
	
	/*
	 * wraper for $this->save()
	 */
	public static function saveTemplate($clientid = 0, $action = "default" , $file_path = "" , $file_nicename = "nicename", $comments = '')
	{
	
		$result = false;
	
		if( empty($clientid) || empty($file_path)) {
			
			return $result;
		}
	
		//create DOCX_TEMPLATE_PATH/$clientid/$action
		$i = 0;
		$path = DOCX_TEMPLATE_PATH . '/' . $clientid . '/' . $action;
		while( ! is_dir($path))
		{
			@mkdir($path , 0755, true);
			if($i >= 5)
			{
				return $result;
			}
			$i++;
		}
	
		$extension = pathinfo($file_path, PATHINFO_EXTENSION);
	
		$destination_file_name = time() . "_file." . $extension;
	
		$destination_file_path = $path . '/' . $destination_file_name;
	
	
		if (copy($file_path, $destination_file_path)) {
			 
			@unlink( $file_path );
			 
			$docx = new DocxTemplates();
			$docx->clientid		= $clientid;
			$docx->action		= $action;
			$docx->file_name	= $destination_file_name;
			$docx->file_nicename= $file_nicename;
			$docx->file_type	= $extension;
			$docx->comments		= $comments;
			$docx->save();
			
			$result = $docx->id;
		}
	
		return $result;
	}


	public function getTemplate($clientid = 0, $id = 0)
	{
		if ((int)$id == 0) {
			//get default template if you don't send a valid id, or you send the default filename
			return self::getDefaultTemplate($clientid, $id );
		}
		
		$result =  false;
		
		$q = $this->getTable()->createQuery()
		->select('*')
		->where('id = ? ', $id)
		->andWhere('clientid = ? ', $clientid)
		->andWhere('isdelete=0')		
		->fetchArray();
		
		if ( ! empty($q)) {
			$result =  $q[0];
		}
		return $result;	
		
	}
	
	
	/**
	 * 
	 * per client default in  DOCX_TEMPLATE_PATH . '/' . $clientid . '/defaults/' . $filename
	 * general default in DOCX_TEMPLATE_PATH . '/defaults/' . $filename
	 * 
	 * Aug 21, 2017 @claudiu 
	 * 
	 * @param number $clientid
	 * @param string $filename
	 * @return string|boolean
	 */
	public static function getDefaultTemplate($clientid = 0, $filename = "default_4_action.docx")
	{	
		
		$result =  array(
				'clientid' => $clientid,
				'action' => pathinfo($filename, PATHINFO_FILENAME) ,
				'file_name' =>  $filename,
				'file_nicename' => 'default_'. $filename,
				'fullPath' => '',
		);
		
		//default for each client
		$file = DOCX_TEMPLATE_PATH . '/' . $clientid . '/defaults/' . $filename; 
		if (is_file($file)) {
			
			$result['fullPath'] = $file;
			return $result;
		} 

		//fallback to general default
		$file = DOCX_TEMPLATE_PATH . '/defaults/' . $filename;
		if (is_file($file)) {
			
			$result['fullPath'] = $file;
			return $result;
		}
		
		return false;	
		
	}
}