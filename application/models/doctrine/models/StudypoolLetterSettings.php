<?php

/**
 * StudypoolLetterSettings
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class StudypoolLetterSettings extends BaseStudypoolLetterSettings
{

	public static  $default_docx_template = "studypool.docx";
	
	
	private static $mandatory_columns = array(			
			'clientid',
	);
	
	public function set_new_record($params = array())
	{
	
		if (empty($params) || !is_array($params)) {
			return false;// something went wrong
		}
		
		foreach (self::$mandatory_columns as $column) {

			if ( empty($params[$column]) &&  empty($this->{$column}) )
			{
				return false;
			}
		}

		foreach ($params as $k => $v)
			if (isset($this->{$k})) {
				$this->{$k} = $v;
			}

		$this->save();
		
		return $this->id;
	
	}

	/**
	* we don't set isdelete= 1, instead we order by id desc limit 1.... @todo change to isdelete=1 when needed
	*/
	public function getByClientid( $clientid ) 
	{
				
		$q = $this->getTable()->createQuery('sls')
		->select('sls.*, docxt.*')
		->where('clientid = ? ', $clientid)
		->andWhere('isdelete=0')
		->leftJoin('sls.DocxTemplates docxt')
		->orderBy('id DESC')
		->limit(1)
		->fetchArray();
		
		if(! empty($q[0])){
			$q = $q[0];
			
			
			
			if( ! empty($q['DocxTemplates'])) {
				$q['template_nicename'] = $q['DocxTemplates'] ['file_nicename'];
			} else {
				//get the defaults
				$q['DocxTemplates'] = DocxTemplates::getDefaultTemplate($clientid, self::$default_docx_template);
				
				$q['DocxTemplates']['template_id'] =
				$q['template_id'] = self::$default_docx_template;
				
				$q['template_nicename'] = $q['DocxTemplates'] ['file_nicename'];
				
				
			}
		}
		return $q;
	}

}