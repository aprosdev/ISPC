<?php

/**
 * MePatientDevicesTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @method createIfNotExistsOneBy($fieldName, $value = null, array $data = array())
 * @method findOrCreateOneBy($fieldName, $value = null, array $data = array())
 * 
 * @package    ISPC
 * @subpackage Application (2020-01-13)
 * @author     Ancuta <office@originalware.com>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class MePatientDevicesTable extends Pms_Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return MePatientDevicesTable (object)
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('MePatientDevices');
    }
    
    
    public static function find_patient_devices($ipid = 0,$only_active = false,$onlyWithNotificationsEnabled = false)
    {
        if(empty($ipid)){
            return;
        }
        
        $poa = self::getInstance()->createQuery('s INDEXBY id')
        ->select('s.*,sc.*')
        ->where('s.ipid =?', $ipid)
        ->andWhere('s.isdelete = 0');
        
        if($only_active){
            $poa->andWhere('s.active = "yes"');
        }
        
        if($onlyWithNotificationsEnabled){
            $poa->andWhere('s.registration_id != ""');
            $poa->andWhere('s.registration_id NOT LIKE "%notifications_disabled%"');
        }
        $poa->leftJoin('s.MePatientDevicesSurveys as sc');
        $result = $poa->fetchArray();
        
        return $result;
        
        
    }
    
    public static function find_patient_deviceByIpidAndId($ipid = 0,$device_id = 0,$only_active = false)
    {
        if(empty($ipid) || empty($device_id)){
            return;
        }
        
        $poa = self::getInstance()->createQuery('s INDEXBY id')
        ->select('s.*,sc.*')
        ->where('s.ipid =?', $ipid)
        ->andWhere('s.id =?', $device_id);
        if($only_active){
            $poa->andWhere('s.active = "yes"');
        }
        $poa->leftJoin('s.MePatientDevicesSurveys as sc');
        $result = $poa->fetchArray();
        
        return $result;
        
        
    }
   
    /**
     * @author Ancuta 
     * ISPC-2432
     * 30.01.2020
     * Get all Active devices  modified in the last 24 hours
     * @return array|Doctrine_Collection
     */
    public static function find_active_devices2send()
    {
        $result = array();
        $poa = self::getInstance()->createQuery('s INDEXBY id')
        ->select('s.*,sc.*, IF((s.change_date <= NOW()) AND (s.change_date>= NOW() - INTERVAL 24 HOUR), true, false) AS changed_in_last_24h,IF((s.create_date <= NOW()) AND (s.create_date >= NOW() - INTERVAL 24 HOUR), true, false) AS created_in_last_24h  ')
        ->where('s.active = "yes"');
        $poa->leftJoin('s.MePatientDevicesSurveys as sc');
        $poa->having('changed_in_last_24h = 1 OR created_in_last_24h = 1');
        $result = $poa->fetchArray();
 
        return $result;
        
        
    }
    
}