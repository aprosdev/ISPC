<?php

/**
 * PharmaRequestsReceivedTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @method createIfNotExistsOneBy($fieldName, $value = null, array $data = array())
 * @method findOrCreateOneBy($fieldName, $value = null, array $data = array())
 * 
 * @package    ISPC
 * @subpackage Application (2020-02-09)
 * @author     Ancuta <office@originalware.com>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 * ISPC-2507
 */
class PharmaRequestsReceivedTable extends Pms_Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return PharmaRequestsReceivedTable (object)
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('PharmaRequestsReceived');
    }
    
    /**
     * @author Ancuta
     * 19.02.2020
     * ISPC-2507
     * @param string $ipid
     * @param boolean $doctor_id
     * @param boolean $request_user_id
     * @return void|array|Doctrine_Collection
     */
    public static function find_patient_last_NotProessed_request($ipid = '',$doctor_id = false, $request_user_id = false)
    {
        
        if (empty($ipid)) {
            return;
        }
        
        $q = self::getInstance()->createQuery()
        ->select('*')
        ->where('ipid =?', $ipid);
        
        if ($doctor_id) {
            $q->andWhere('doctor_id =? ', $$doctor_id);
        }
        if ($request_user_id) {
            $q->andWhere('request_user =? ', $$request_user_id);
        }
        $q->andWhere('processed =? ', "no");
        $q->orderBy('create_date DESC');
        $q->limit('1');
        $result = $q->fetchArray();
        
        return $result;
        
    }
}