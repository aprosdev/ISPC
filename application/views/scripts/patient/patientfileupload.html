<!-- Maria:: Migration ISPC to CISPC 08.08.2020 -->
<?php 
	$this->headLink()->appendStylesheet(RES_FILE_PATH . '/css/qtip/jquery.qtip.min.css?' . date('Ymd'));
	$this->headLink()->appendStylesheet(RES_FILE_PATH . '/css/tags_editor/jquery.tag-editor.css?' . date('Ymd'));
	$this->headLink()->appendStylesheet(RES_FILE_PATH . '/css/patientfile.css?' . date('Ymd'));
	$this->headScript()->appendFile(RES_FILE_PATH . '/javascript/qtip/jquery.qtip.min.js?' . date('Ymd'));
	$this->headScript()->appendFile(RES_FILE_PATH . '/javascript/tags_editor/jquery.tag-editor.js?' . date('Ymd'));
	$restricted_tags = $this->restricted_tags;
	$all_tags = $this->all_tags;
	$patient_file_tag_rights_arr = explode(',', $this->patient_file_tag_rights);
	$patient_file_tag_rights_js = json_encode(explode(',', $this->patient_file_tag_rights));

	//ISPC-2642 Ancuta 10-11.08.2020
	$this->headLink()->appendStylesheet(RES_FILE_PATH . '/css/page-css/patientfileupload/upload-files.css');


    //add file uploader
    $this->headScript()->appendFile(RES_FILE_PATH.'/javascript/fine-uploader/fine-uploader.min.js');
    $this->headLink()->appendStylesheet(RES_FILE_PATH.'/javascript/fine-uploader/fine-uploader.css');

    //rendered-add the fine-uploader file-uploader template
    //$qqtemplate = $this->render("templates/qq_fileupload_template_small_2017_09.html");
    $qqtemplate = Pms_Template::createTemplate(array(), 'templates/qq_fileupload_template_multiple_2018_09.html');
    $this->headScript()->setAllowArbitraryAttributes(true)->appendScript($qqtemplate, 'text/template', array("id" => "qq-template", "noescape" => true));


?>
<script type="text/javascript">
	
	var isdischarged = <?php echo $this->isdischarged; ?>;
	var restricted_tags = jQuery.parseJSON('<?php echo $this->restricted_tags_js; ?>');
	var all_tags = jQuery.parseJSON('<?php echo $this->all_tags_js; ?>');
	var patient_file_tag_rights = jQuery.parseJSON('<?php echo $patient_file_tag_rights_js; ?>');
	//ISPC-2831 Dragos 15-22.03.2021
    var elsa_files_module = <?=$this->allow_tagbuttons ? "true" : "false";?>;

	//ISPC-2642 Ancuta 10-11.08.2020
	var currentfileTags = false
	<?php if(isset($_REQUEST['file_id']) && !empty($_REQUEST['file_id']) && !empty($this->current_file_data["initialTags_js"])):?>
		var currentfileTags = jQuery.parseJSON('<?php echo $this->current_file_data["initialTags_js"]; ?>');
	<?php endif;?> 
	var tag_ids = {};
	 tag_ids['LABOR'] = "<?php echo $this->all_tagsname2ids['LABOR']; ?>";
	 tag_ids['BEFUND'] = "<?php echo $this->all_tagsname2ids['BEFUND']; ?>";
	 tag_ids['BRIEFE'] = "<?php echo $this->all_tagsname2ids['BRIEFE']; ?>";
	
	//--
	
	$(document).ready(function(){
		//ISPC-2642 Ancuta 10-11.08.2020
		$('.pf_edit_cont').removeClass('blink_edit_cont');
		<?php if(!empty($_GET['file_id']) ):?>
		$(window).load(function() {
// 			  $("html, body").animate({ scrollTop: $(document).height()+100 }, 1000);
		
		 	$('html, body').animate({
	            scrollTop: $("#edif_file_name").offset().top
	        }, 100, function() {
	            $("#edif_file_name").focus();
	        });
			});
		
		
			$('.pf_edit_cont').addClass('blink_edit_cont');
			
			setTimeout(function() {
				$('.pf_edit_cont').removeClass('blink_edit_cont');
			}, 4500);
		<? endif;?>
		$('.tagFile_upload').each(function(){
			var tag_name ="";
			var tag_name = $(this).data('tag');
			
			  tag_uploader_create(
					    this,
			    		['*', 'pdf', 'docx', 'doc', 'xml', 'xls', 'csv'],
			    		null,
			    		true,
			    		tag_name
			    		);
		});		
 		//-- 
		
		$('#tag_name').tagEditor({
			placeholder: '<?php echo $this->translate("enter_tags"); ?>',
			minLength: '3',
			maxLength: '255',
			initialTags: currentfileTags,//ISPC-2642 Ancuta 10-11.08.2020
			forceLowercase: false,
			onChange: function(ui) {
				//element is the textarea
				var content = ui.val();
				var content_obj = content.split(',');
				
				$.each(content_obj, function(index, value){
					if(jQuery.inArray(value, restricted_tags) >= "0")
					{
						$('#tag_name').tagEditor('removeTag', value);
					}
					
					if(jQuery.inArray(value, all_tags) < "0" && value !='')
					{						
						if(jQuery.inArray('create', patient_file_tag_rights) < "0")
						{
							alert('<?php echo $this->translate('No rights to add new tags!').$this->translate('The tag').' '; ?>'+value+' '+'<?php echo $this->translate('will not be saved!'); ?>');
							$('#tag_name').tagEditor('removeTag', value);
						}
					}
				});
			}
		});
		
//		$('.tags_editor').live('click', function(){
//			$('#dialog_edit_file').dialog('open');
//		});
//		$('#dialog_edit_file').dialog({
//			autoOpen: false,
//			modal: true,
//			title: "<?php echo $this->translate('edit_file_tags'); ?>",
//			resizable: false,
//			draggable: false,
//			close: function () {
//				reset_edit_dialog();
//			},
//			buttons: {
//				"<?php echo $this->translate('submit'); ?>": function () {
////					$('#save_edit_tag').submit();
//					reset_edit_dialog();
//				},
//				"<?php echo $this->translate('cancel'); ?>": function () {
//					reset_edit_dialog();
//					$(this).dialog("close");
//				}
//			}
//		});
		
		$('.tags_selector a').on('click', function() {
			/*if(jQuery.inArray('use', patient_file_tag_rights) < "0")
			{
				alert('No rights to use tags! The tag '+$(this).attr('rel')+' will not be added!');
				$('#tag_name').tagEditor('removeTag', $(this).attr('rel'));
			}
			else
			{*/
				$('#tag_name').tagEditor('addTag', $(this).attr('rel'));
			//}
		});
		
		$('.tags_info').qtip({
			style: {
				name: 'cream',
				tip: true
			},
			position: {
				my: 'center right',  // Position my top left...
				at: 'center left' // at the bottom right of...
			},
			show: {
				event: 'click mouseenter'
			},
			hide: {
				event: 'click mouseout'
			}
		});
				
		$('a.tag').live('click', function(){
			if($(this).attr('rel') !== '0')
			{
				var tag_id = $(this).attr('rel');
			}
			else
			{
				var tag_id = "all";
			}
			
			$('.tag_all').hide();
			$('.tag_'+tag_id).show('slow');
			$('a.tag').removeClass('selected');
			$('[rel='+$(this).attr('rel')+']').addClass('selected');
			//$(this).addClass('selected');
		});
		// Delete file with confirmation
		$("#pfileremove").live('click', function() {
			$.confirmdeletepid = $(this).attr('rel_pid');
			$.confirmdeleteid = $(this).attr('rel_id');
				jConfirm('<? echo $this->translate('confirmsingledeleterecord'); ?>', '<? echo $this->translate('confirmdeletetitle'); ?>', function(r) {
				if(r)
				{
                    <?php //ISPC-2831 Dragos 15.03.2021 ?>
					location.href = "<? echo APP_BASE ?>patient/patientfileremove?id="+ $.confirmdeletepid+"&did="+$.confirmdeleteid+"<?=$this->efa?'&efa=1':''?>";
				}
			});
		});
        <?php //ISPC-2831 Dragos 15.03.2021
        if( $this->allow_tagbuttons  ): ?>
        $(".pfileedit").live('click', function() {
            let pid = $(this).attr('rel_pid');
            let id = $(this).attr('rel_id');
            $.ajax({
                url: appbase+'patient/patientfileupload?id='+pid+'&act=edit_modal&file_id='+id,
                method: "GET"
            }).done(function (response) {
                let file = {}
                try {
                    file = JSON.parse(response.trim())
                } catch (e) {
                    console.log('error parsing file details json')
                    return false
                }
                console.log(file)
                if (file.comment == null) file.comment = '';
                if (file.meta_name == null) file.comment = '';
                var f_template = $('#file_modal_template')
                var child = f_template.clone().attr('id', file.id).attr('is_update', 1).show()
                child.find('fieldset').attr('id',file.id)
                child.find('legend').text(file.title)
                child.find('textarea.tag_name').text(file.initialTags)
                child.find('textarea.comment').text(file.comment)
                child.find('select.fall').val(file.admission_id)
                child.find('input.meta_name').val(file.meta_name)
                //child.find('textarea.tag_name').val(tag_name).attr('id', 'tag_name_'+id)
                $('#upload_modal').append(child)
                $('#upload_modal').dialog('open')
            })




        });
        $('#content').on('change','#pat_adm' ,function () {
            ajaxCallserver({url: appbase+'patient/fetchpatientfile?id=<?php echo $_REQUEST['id'] ?>&clm=date&ord=<?php echo $this->order ?>&pgno=<?php echo  $_REQUEST['pgno'] ?>&tag=<?php echo $_REQUEST['tag']; ?>&pat_adm='+this.value+'<?=$this->efa?'&efa=1':''?>', callLoading: pl_loading})
        })

        $('#upload_modal').dialog({
            dialogClass : "",
            modal : true,
            autoOpen : false,
            closeOnEscape : false,
            title: translate("uploadfile"),
            minWidth : 800,
            buttons: {
                "<?php echo $this->translate('save'); ?>": function () {
                    let has_errors = false;
                    $('#upload_modal > div').each(function () {
                        let f_id = $(this).attr('id')
                        let is_update = $(this).attr('is_update')
                        let meta_name = $(this).find('.meta_name').val()
                        let tags = $(this).find('.tag_name').val()
                        let fall = $(this).find('.fall').val()
                        let comment = $(this).find('.comment').val()
                        if (is_update != 1) {
                            $('li[qq-file-id="'+f_id+'"] input.qquuid_file_meta_name').val(meta_name)
                            $('li[qq-file-id="'+f_id+'"] input.qquuid_file2tag').val(tags)
                            $('li[qq-file-id="'+f_id+'"] input.qquuid_file_admission_id').val(fall)
                            $('li[qq-file-id="'+f_id+'"] input.qquuid_file_comment').val(comment)
                        } else {
                            $('li[qq-file-id="0"] input.qquuid_file_meta_name').val(meta_name)
                            $('li[qq-file-id="0"] input.qquuid_file2tag').val(tags)
                            $('li[qq-file-id="0"] input.qquuid_file_admission_id').val(fall)
                            $('li[qq-file-id="0"] input.qquuid_file_comment').val(comment)
                            $('li[qq-file-id="0"] input.qqfile_id').val(f_id)
                        }
                        if (!meta_name.length || meta_name == undefined) {
                            has_errors = 1;
                            $(this).find('.meta_name_column > ul').addClass('errors').children('li').text("<?=$this->translate('required_meta_name')?>")
                        }
                    })

                    if (!has_errors) {
                        checkdischargednew('frmuser')
                    }
                },
                "<?php echo $this->translate('cancel'); ?>": function () {
                    $(this).dialog("close");
                },
            },
            open: function () {

                $('#upload_modal textarea.tag_name').tagEditor({
                    placeholder: '<?php echo $this->translate("enter_tags"); ?>',
                    minLength: '3',
                    maxLength: '255',
                    //initialTags: currentfileTags,//ISPC-2642 Ancuta 10-11.08.2020
                    forceLowercase: false,
                    onChange: function(ui) {
                        //element is the textarea
                        var content = ui.val();
                        var content_obj = content.split(',');

                        $.each(content_obj, function(index, value){
                            if(jQuery.inArray(value, restricted_tags) >= "0")
                            {
                                $(ui).tagEditor('removeTag', value);
                            }

                            if(jQuery.inArray(value, all_tags) < "0" && value !='')
                            {
                                if(jQuery.inArray('create', patient_file_tag_rights) < "0")
                                {
                                    alert('<?php echo $this->translate('No rights to add new tags!').$this->translate('The tag').' '; ?>'+value+' '+'<?php echo $this->translate('will not be saved!'); ?>');
                                    $(ui).tagEditor('removeTag', value);
                                }
                            }
                        });
                    }
                });

                $('#upload_modal .tags_selector a').off('click').on('click', function() {
                    $(this).parents('table').find('textarea.tag_name').tagEditor('addTag', $(this).attr('rel'));
                });
            },
            close: function () {
                $('#upload_modal .file_meta_data').each(function () {
                    let id = $(this).attr('id')
                    $('li[qq-file-id="'+id+'"] span.qq-upload-delete-selector').trigger('click')
                })
                $('#upload_modal').html('')
            }
        })
        <?php endif;
        // -- // ?>
	});
	
	function reset_edit_dialog() {
		$('#dialog_edit_content').html('');
	}
	
	//list and sort
	var pl_loading = function () {
	    var dlist = '<div class="loadingdiv" align="center"><img src="<?php echo RES_FILE_PATH; ?>/images/pageloading.gif"><br />	Loading... please wait</div>';
	    document.getElementById('content').innerHTML = dlist;
		
	}

	function loadpage(ord, clm)
	{
	    if($('#hdnlastpage').val() >= parseInt($('#pageno').val())) {
		if((parseInt($('#pageno').val())) > 0) {
		    pgno = (parseInt($('#pageno').val() - 1));
		} else {
		    pgno = 0;
		}
        <?php //ISPC-2831 Dragos 15.03.2021 ?>
		ajaxCallserver({url: appbase + 'patient/fetchpatientfile?id=<?php echo $_REQUEST['id'];?>&clm=' + clm + '&ord=' + ord + '&pgno=' + pgno +'<?=$this->efa?'&efa=1':''?>', callLoading: pl_loading});
	    } else {
		jAlert("<?php echo $this->translate('invalidpageno'); ?>");
	    }
	}

	var callBack = function (params)
	{
	    document.getElementById('content').innerHTML = params.fileslist;
		
		$('.tags_info').qtip({
			style: {
				name: 'cream',
				tip: true
			},
			position: {
				my: 'center right',  // Position my top left...
				at: 'center left' // at the bottom right of...
			},
			show: {
				event: 'click mouseenter'
			},
			hide: {
				event: 'click mouseout'
			}
		});
	}
	
</script>
<!-- 
<link href="<?php echo RES_FILE_PATH; ?>/javascript/jgrowl/filepatient.css" rel="stylesheet" type="text/css">
 -->
<?php //ISPC-2831 Dragos 15.03.2021
if( $this->allow_tagbuttons  ): ?>
<style>
    table.file_upload_table tbody tr td{
        padding-right: 10px !important;
    }
    table.file_upload_table tbody tr td input, .file_upload_table tbody tr td textarea {
        width: 50% !important;
        margin-right: 10px;
    }
    table.file_upload_table tbody tr td.comment_label {
        vertical-align: top;
    }
    .tagFile_upload .qq-uploader-selector.qq-uploader {
        width: calc(25% - 10px);
    }
</style>
<?php endif;
if ($this->efa) :
$this->headLink()->appendStylesheet(RES_FILE_PATH . '/css/page-css/efadiagnosis.css');
?>
<style>
    .tab_container {
        border: none!important;
        float: none!important;
    }
</style>
    <div id="diagnosis_and_findings_tabs" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
        <ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
            <li class="ui-state-default ui-corner-top"><a href="<?=APP_BASE?>efa/diagnosis?id=<?=$_REQUEST['id']?>">Diagnosen</a></li>
            <li class="ui-state-default ui-corner-top ui-tabs-selected ui-state-active"><a href="<?=APP_BASE?>patient/patientfileupload?id=<?=$_REQUEST['id']?>&efa=1">Befunde</a></li>
            <li class="ui-state-default ui-corner-top"><a href="<?=APP_BASE?>efa/interventions?id=<?=$_REQUEST['id']?>">Interventionen</a></li>
            <li class="ui-state-default ui-corner-top"><a href="<?=APP_BASE?>efa/reactions?id=<?=$_REQUEST['id']?>">Reaktionen</a></li>
            <li class="ui-state-default ui-corner-top"><a href="<?=APP_BASE?>efa/vaccinations?id=<?=$_REQUEST['id']?>">Impfstatus</a></li>
            <li class="ui-state-default ui-corner-top"><a href="<?=APP_BASE?>efa/history?id=<?=$_REQUEST['id']?>">bisherige Krankengeschichte</a></li>
        </ul>
        <div id="tabs-2" style="padding: 1em">
<?php endif;
//  --  //
?>

<form enctype="multipart/form-data"  action="<?php echo $this->act ?>" method="post" name="frmuser" id="frmuser" autocomplete="off" >
	<div style="display: none;">
		<img id="calImg" src="<?php echo RES_FILE_PATH; ?>/images/calendar.png" alt="Popup" class="trigger">
	</div>
	

	<div class="tab_container">
	<!-- <a href="<?php echo APP_BASE ?>patient/patientfileupload?id=<?php echo $this->enc_id; ?>#jump_here">[Add file]</a> -->
		<div id="TableContentOuter">
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td>
						<table width="100%" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td width="50%" class="doc_title_left"><h1><?php echo $this->translate('documents'); ?></h1></td>
                                <?php //ISPC-2831 Dragos 15.03.2021
                                    if( !$this->allow_tagbuttons  ): ?>
								        <td width="50%" class="doc_title_right"><h2><a href="<?php echo APP_BASE ?>patient/patientfileupload?id=<?php echo $this->enc_id; ?><?=$this->efa?'&efa='.$this->efa:''?>#jump_here"><?php echo $this->translate('[Add file]')?></a></h2>
                                <?php else:?>
                                            <td></td>
                                <?php endif;?>
							</tr>
						</table>
					</td>
					<!-- <td width="23" align="left"  valign="top"><h1><?php echo $this->translate('documents'); ?></h1></td> -->
				</tr>
				
				
				<tr>
					<td>



<?php if( $this->allow_tagbuttons  ): ?>
<!-- new code files upload -->
<div class="tags_quick_file_upload">
	<input type="hidden" name="fileuploads" value="1" /> 
	<input type="hidden" name="post_action" value="" /> 
	<input type="hidden" name="file_id" value="0" /> 
	<div class="tagFile_upload" id="tagFile_upload_labor" data-tag="LABOR"></div>
	<div class="tagFile_upload" id="tagFile_upload_befund" data-tag="BEFUND"></div>
	<div class="tagFile_upload" id="tagFile_upload_briefe"  data-tag="BRIEFE"></div>
    <div class="tagFile_upload" id="tagFile_upload_other"  data-tag="OTHER"></div>
	<input type="hidden" name="active_version" id="active_version" value="0"/> <!-- ISPC - 2129 -->
	<input type="hidden" name="pat_files_tags_rights"   value="<?php echo $this->patient_file_tag_rights; ?>" />
    <?php /*ISPC-2831 Dragos 15.03.2021
<!--	<input type="button" name="btnsubmit" id="btnsubmit-save" value="--><?php //echo $this->translate('submit') ?><!--" class="input-shortcuts-small" onclick="checkdischargednew('frmuser')">-->
 */ ?>
</div>
<!-- // new code files upload -->
<?php endif; ?>



					</td>
				</tr>
				
				
				<tr style="display:<?php echo $this->style ?>">
					<td align="left" valign="top" >
						<div id="content">
							<!--Ajax loaded data-->
						</div>
					</td>
				</tr>
				<tr style="display:<?php echo $this->style ?>">
					<td align="left" valign="top" >
						&nbsp;<br />
					</td>
				</tr>
                <?php //ISPC-2831 Dragos
                if (!$this->allow_tagbuttons):?>
				<tr>
					<td width="23" align="left" valign="top">&nbsp;</td>
				</tr>
				<tr>
					<td width="23" align="left" valign="top"><strong><?php echo $this->translate('uploadnewfile'); ?></strong></td>
				</tr>
				<tr>
					<td width="23" align="left" valign="top">&nbsp;</td>
				</tr>
				<tr>
					<td align="left" valign="top" class="pf_edit_cont">
						<div id="TableContentOuter" style="display:<?php echo $this->styleadd ?>">
							<input type="hidden" name="fileuploads" value="1" /> 
							<table width="100%" border="0" cellspacing="0" cellpadding="0">
								<!-- <tr>
									<td width="35%" height="28" align="left" valign="top"><?php echo $this->translate('file_upload_title') ?></td>
									<td width="28%" height="28" align="left" valign="top"><label>
											<input type="text" name="title" id="title" />
											<input type="hidden" name="fileuploads" value="1" /> 
										</label></td>
									<td width="21%" height="28" align="left" valign="top" class="err"><?php echo $this->error_title; ?></td>
									<td width="39%" height="28" align="left" valign="top">&nbsp;</td>
								</tr> -->
								<tr>
									<td width="20% align="left" class="file_upload"><?php echo $this->translate('uploadfile_user_new') ?>*</td>
									<td align="left" style="padding-bottom: 5px">
										<!-- ISPC-2642 Ancuta 10-11.08.2020 -->
										<?php if(isset($_REQUEST['file_id']) && !empty($_REQUEST['file_id']) && !empty($this->current_file_data)):?>
											<?php $current_file = $this->current_file_data; ?>
											<div class="qq_file_uploader_placeholder">
											<div class="  qq-uploader bigupload">
											    <ul class="qq-upload-list-selector qq-upload-list qq-upload-list-visible" aria-live="polite" aria-relevant="additions removals">
											    <li class="qq-file-id-0 qq-upload-success" qq-file-id="0">
											            <div class="qq-file-info">
											                <span class="infolabel">Dokument benennen:</span>
											                <div class="qq-file-name">
											                    <div role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="qq-progress-bar-selector qq-progress-bar qq-hide"></div>
											                    <input type="text" class="qquuid_file_title qq-edit-filename-selector" id="edif_file_name" name="title" value="<?php echo $current_file['title'];?>" tabindex="0">
											                    <input type="hidden" name="post_action" value="update_file_data">
											                    <input type="hidden" name="file_id" value="<?php echo $current_file['id'];?>" tabindex="0">
											                    <input type="hidden" name="fileuploads" value="0" /> 
											                </div>
											            </div>
											        </li></ul>

											</div>		
											</div>		
                                        <? else: ?>
                                        <div id="qq_file_uploader_placeholder" class='qq_file_uploader_placeholder qq_file_uploader_multiple' data-parent='fieldset' data-action_name="upload_patient_files" data-tabname="0">
                                            <noscript>
                                                Please enable JavaScript to use file uploader.
                                            </noscript>
                                        </div>
                                        <? endif; ?>
                                        
                                        <!--
                                        <div id="file-uploader-demo1">
											<noscript>
											Please enable JavaScript to use file uploader.
											</noscript>
										</div>
                                         
										<script src="<?php echo RES_FILE_PATH; ?>/javascript/jgrowl/fileuploader.js" type="text/javascript"></script>
                                        

										<script>
										function createUploader() {
											var uploader = new qq.FileUploader({
											element: document.getElementById('file-uploader-demo1'),
											action: appbase + 'patient/uploadify',
											onSubmit: function (id, fileName) {
												$('#btnsubmit').attr("disabled", "true");
											},
											onComplete: function (id, fileName, responseJSON) {
												$('#btnsubmit').removeAttr("disabled");
											}
											});
										}

										// in your app create uploader as soon as the DOM is ready
										// don't wait for the window to load
										window.onload = createUploader;
										</script>  
                                         -->
                                        
                                        </td>
                                        <!-- 
									<td width="44%" align="left" class="file_upload"><input type="text" name="title" id="title" /></td>
									
                                    <td align="left" class="file_upload">(<?php echo $this->translate('maxfilesize'); ?>: <?php echo ini_get('upload_max_filesize'); ?>B)</td>
									<td align="left" class="err file_upload"><?php echo $this->error_filename; ?></td>
                                         -->
								</tr>
								<tr>
									<td width="20%" align="left" class="file_upload">
										<label for="tag_name"><?php echo $this->translate('file_upload_tags_new') ?></label>
									</td>
									<td colspan="3" align="left" class="tags_sel_cell file_upload">
										<!-- <td colspan="2" height="28" align="left" style="padding: 0px; vertical-align: top;" class="tags_sel_cell"> -->
										<div class="clearer"></div>
										<?php if(in_array('create', $patient_file_tag_rights_arr)) 
										{
										?>
												<textarea id="tag_name" name="tag_name"></textarea>
											<?php } else { 
												if(in_array('use', $patient_file_tag_rights_arr))
												{
											?>
												<textarea id="tag_name" name="tag_name"></textarea>
											<?php } else { ?>
												<textarea id="no_tag" name="no_tag" placeholder="<?php echo $this->translate('enter_tags'); ?>" style="width:100%; height: 100%;" disabled></textarea>
											<?php } ?>
										<?php } ?>
									</td>
									<td align="left" class="err file_upload"></td>
									<!-- <td width="39%" height="28" align="left" style="vertical-align: top;">&nbsp;</td> -->
								</tr>
							</table>
							<div style="width: 100%;height:auto;display: inline-block;">
								<?php if($this->system_tags): 
									if(in_array('use', $patient_file_tag_rights_arr)) 
									{
										$first_tag = 0;
								?>
										<ul class="tags tags_selector">
										<?php foreach($this->system_tags as $k_ctag => $vs_ctag): ?>
											<?php if(!in_array($vs_ctag['tag'], $this->restricted_tags)): ?>
												<?php if ($first_tag == 0) { ?>
												<li>
													<a id="jump_here" href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system"><?php echo $vs_ctag['tag']; ?></a>
												</li>
												<?php
													$first_tag++; 
												} else { ?>
												<li>
													<a href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system"><?php echo $vs_ctag['tag']; ?></a>
												</li>
											<?php } endif; ?>
										<?php endforeach; ?>
										</ul>
									<?php } else { 
										$first_tag = 0;
									?>
										<ul class="tags">
										<?php foreach($this->system_tags as $k_ctag => $vs_ctag): ?>
											<?php if(!in_array($vs_ctag['tag'], $this->restricted_tags)): ?>
											<?php if ($first_tag == 0) { ?>
												<li>
													<a id="jump_here" href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system syst_use"><?php echo $vs_ctag['tag']; ?></a>
												</li>
											<?php 
												$first_tag++;
												} else { ?>									
												<li>
													<a href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system syst_use"><?php echo $vs_ctag['tag']; ?></a>
												</li>
											<?php } endif; ?>
										<?php endforeach; ?>
										</ul>
									<?php } ?>
								<?php endif; ?>

								<?php if($this->client_tags): 
									if(!$this->system_tags)
									{
										$first_tag = 0;
									}
									if(in_array('use', $patient_file_tag_rights_arr)) 
									{
								?>
										<ul class="tags tags_selector">
											<?php foreach($this->client_tags as $k_ctag => $v_ctag): ?>
												<?php if(!in_array($v_ctag['tag'], $this->restricted_tags)): ?>
													<?php if(!$this->system_tags && $first_tag == 0) { ?>
														<li>
															<a id="jump_here" href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom"><?php echo $v_ctag['tag']; ?></a>
														</li>
													<?php 
														$first_tag++;
													} else { ?>
														<li>
															<a href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom"><?php echo $v_ctag['tag']; ?></a>
														</li>
												<?php } endif; ?>
											<?php endforeach; ?>
										</ul>
									<?php } else { ?>
										<ul class="tags">
											<?php foreach($this->client_tags as $k_ctag => $v_ctag): ?>
												<?php if(!in_array($v_ctag['tag'], $this->restricted_tags)): ?>
													<?php if(!$this->system_tags && $first_tag == 0) { ?>
														<li>
															<a id="jump_here" href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom cust_use"><?php echo $v_ctag['tag']; ?></a>
														</li>
													<?php 
													$first_tag++;
													} else { ?>
														<li>
															<a href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom cust_use"><?php echo $v_ctag['tag']; ?></a>
														</li>
												<?php } endif; ?>
											<?php endforeach; ?>
										</ul>
								<?php } ?>			
							<?php endif; ?>
							</div>
							<div style="width: 100%;">
								<input type="hidden" name="active_version" id="active_version" value="0"/> <!-- ISPC - 2129 -->
								<input type="button" name="btnsubmit" id="btnsubmit-save" value="<?php echo $this->translate('submit') ?>" class="button btnSubmit2018" onclick="checkdischargednew('frmuser')">
								<input type="hidden" name="pat_files_tags_rights" value="<?php echo $this->patient_file_tag_rights; ?>" />
							</div>
						</div>
					</td>
				</tr>
                <?php else : //hidden form for edit  ISPC-2831 Dragos?>
                <tr><td>
                    <div class="edit_file" style="display: none">
                        <div class="qq_file_uploader_placeholder">
                            <div class="  qq-uploader bigupload">
                                <ul class="qq-upload-list-selector qq-upload-list qq-upload-list-visible" aria-live="polite" aria-relevant="additions removals">
                                    <li class="qq-file-id-0 qq-upload-success" qq-file-id="0">
                                        <div class="qq-file-info">
                                            <div class="qq-file-name">
                                                <div role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="qq-progress-bar-selector qq-progress-bar qq-hide"></div>
    <!--                                            <input type="text" class="qquuid_file_title qq-edit-filename-selector" id="edif_file_name" name="title" value="" tabindex="0">-->
                                                <input type="hidden" class="qquuid_file_meta_name qq-edit-filename-selector" id="edif_meta_name" name="meta_name" value="" tabindex="0">
                                                <input type="hidden" class="qquuid_file2tag qq-edit-filename-selector" id="edif_file2tag" name="tag_name" value="" tabindex="0">
                                                <input type="hidden" class="qquuid_file_admission_id qq-edit-filename-selector" id="edif_admission_id" name="admission_id" value="" tabindex="0">
                                                <input type="hidden" class="qquuid_file_comment qq-edit-filename-selector" id="edif_comment" name="comment" value="" tabindex="0">
                                                <input type="hidden" name="post_action" value="update_file_data">
                                                <input type="hidden" name="file_id" class="qqfile_id" value="" tabindex="0">
                                                <input type="hidden" name="fileuploads" value="0" />
                                            </div>
                                        </div>
                                    </li></ul>

                            </div>
                        </div>
                    </div>
                </td></tr>
                <?php endif; ?>
            </table>
		</div>

	</div>
</form>
<?php //ISPC-2831 Dragos 15.03.2021 ?>
<?php if ($this->efa) :?>
        </div>
    </div>
<?php endif;?>
<script type="text/javascript">
	ajaxCallserver({url: appbase + 'patient/fetchpatientfile?id=<?php echo $_REQUEST['id'];?>&clm=date&ord=DESC&pgno=0<?=$this->efa?'&efa=1':''?>', callLoading: pl_loading});
</script>
<?php if( $this->allow_tagbuttons  ): ?>
<div id="file_modal_template" class="file_meta_data" style="display: none">
    <fieldset>
        <legend></legend>
        <table class="file_upload_table">
            <tbody>
                <tr>
                    <td style="width: 150px">
                        <label><?=$this->translate('meta_name')?></label>
                    </td>
                    <td class="meta_name_column">
                        <input type="text" class="form-control meta_name" required/>
                        <ul><li></li></ul>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label><?=$this->translate('enter_tags')?></label>
                    </td>
                    <td>
                        <?php if(in_array('create', $patient_file_tag_rights_arr))
                        {
                            ?>
                            <textarea class="tag_name" name="tag_name"></textarea>
                        <?php } else {
                            if(in_array('use', $patient_file_tag_rights_arr))
                            {
                                ?>
                                <textarea class="tag_name" name="tag_name"></textarea>
                            <?php } else { ?>
                                <textarea class="no_tag" name="no_tag" placeholder="<?php echo $this->translate('enter_tags'); ?>" style="width:100%; height: 100%;" disabled></textarea>
                            <?php } ?>
                        <?php } ?>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td>
                        <div style="width: 100%;height:auto;display: inline-block;">
                            <?php if($this->system_tags):
                                if(in_array('use', $patient_file_tag_rights_arr))
                                {
                                    $first_tag = 0;
                                    ?>
                                    <ul class="tags tags_selector">
                                        <?php foreach($this->system_tags as $k_ctag => $vs_ctag): ?>
                                            <?php if(!in_array($vs_ctag['tag'], $this->restricted_tags)): ?>
                                                <?php if ($first_tag == 0) { ?>
                                                    <li>
                                                        <a id="jump_here" href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system"><?php echo $vs_ctag['tag']; ?></a>
                                                    </li>
                                                    <?php
                                                    $first_tag++;
                                                } else { ?>
                                                    <li>
                                                        <a href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system"><?php echo $vs_ctag['tag']; ?></a>
                                                    </li>
                                                <?php } endif; ?>
                                        <?php endforeach; ?>
                                    </ul>
                                <?php } else {
                                    $first_tag = 0;
                                    ?>
                                    <ul class="tags">
                                        <?php foreach($this->system_tags as $k_ctag => $vs_ctag): ?>
                                            <?php if(!in_array($vs_ctag['tag'], $this->restricted_tags)): ?>
                                                <?php if ($first_tag == 0) { ?>
                                                    <li>
                                                        <a id="jump_here" href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system syst_use"><?php echo $vs_ctag['tag']; ?></a>
                                                    </li>
                                                    <?php
                                                    $first_tag++;
                                                } else { ?>
                                                    <li>
                                                        <a href="javascript:void(0);" rel="<?php echo $vs_ctag['tag']; ?>" class="system syst_use"><?php echo $vs_ctag['tag']; ?></a>
                                                    </li>
                                                <?php } endif; ?>
                                        <?php endforeach; ?>
                                    </ul>
                                <?php } ?>
                            <?php endif; ?>

                            <?php if($this->client_tags):
                                if(!$this->system_tags)
                                {
                                    $first_tag = 0;
                                }
                                if(in_array('use', $patient_file_tag_rights_arr))
                                {
                                    ?>
                                    <ul class="tags tags_selector">
                                        <?php foreach($this->client_tags as $k_ctag => $v_ctag): ?>
                                            <?php if(!in_array($v_ctag['tag'], $this->restricted_tags)): ?>
                                                <?php if(!$this->system_tags && $first_tag == 0) { ?>
                                                    <li>
                                                        <a href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom"><?php echo $v_ctag['tag']; ?></a>
                                                    </li>
                                                    <?php
                                                    $first_tag++;
                                                } else { ?>
                                                    <li>
                                                        <a href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom"><?php echo $v_ctag['tag']; ?></a>
                                                    </li>
                                                <?php } endif; ?>
                                        <?php endforeach; ?>
                                    </ul>
                                <?php } else { ?>
                                    <ul class="tags">
                                        <?php foreach($this->client_tags as $k_ctag => $v_ctag): ?>
                                            <?php if(!in_array($v_ctag['tag'], $this->restricted_tags)): ?>
                                                <?php if(!$this->system_tags && $first_tag == 0) { ?>
                                                    <li>
                                                        <a href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom cust_use"><?php echo $v_ctag['tag']; ?></a>
                                                    </li>
                                                    <?php
                                                    $first_tag++;
                                                } else { ?>
                                                    <li>
                                                        <a href="javascript:void(0);" rel="<?php echo $v_ctag['tag']; ?>" class="custom cust_use"><?php echo $v_ctag['tag']; ?></a>
                                                    </li>
                                                <?php } endif; ?>
                                        <?php endforeach; ?>
                                    </ul>
                                <?php } ?>
                            <?php endif; ?>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label><?=$this->translate('Period')?></label>
                    </td>
                    <td>
                        <select class="fall">
                            <option value=""><?=$this->translate('none')?></option>
                            <?php foreach ($this->patient_falls_selectbox as $value => $name) :?>
                                <option value="<?=$value?>"><?=$name?></option>
                            <?php endforeach; ?>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="comment_label">
                        <label><?=$this->translate('comment')?></label>
                    </td>
                    <td>
                        <textarea class="comment"></textarea>
                    </td>
                </tr>
            </tbody>
        </table>
    </fieldset>
</div>
<div id="upload_modal">
</div>
<?php
endif;
// -- // ?>
<!--<div id="dialog_edit_file">
	<div id="dialog_edit_content"></div>
</div>-->
